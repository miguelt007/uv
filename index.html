<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Índice UV - IPMA (Organizado por Dia)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        table {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        /* Estilo para as linhas de cabeçalho de Dia */
        .day-header {
            background-color: #004a99; /* Azul escuro para destacar o dia */
            color: white;
            font-weight: bold;
            text-align: center !important;
            font-size: 1.1em;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: #007bff;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tr:nth-child(even):not(.day-header) {
            background-color: #f9f9f9;
        }
        tr:hover:not(.day-header) {
            background-color: #eef7ff;
        }
        .loading, .error-message {
            text-align: center;
            font-size: 1.1em;
            color: #666;
            padding: 20px;
        }
        .error-message {
            color: #d9534f;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>Previsão do Índice UV - IPMA</h1>

    <table id="tabela-uv">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Localidade</th>
                <th>Índice UV Máximo (iUv)</th>
            </tr>
        </thead>
        <tbody id="tabela-corpo">
            <tr><td colspan="3" class="loading">A carregar dados...</td></tr>
        </tbody>
    </table>

    <script>
        const API_URL_UV = 'https://api.ipma.pt/open-data/forecast/meteorology/uv/uv.json';
        const API_URL_LOCALITIES = 'https://api.ipma.pt/open-data/distrits-islands.json';

        /**
         * 1. Função para buscar a lista de localidades e criar um mapa de ID -> Nome.
         * (Mantida da versão anterior)
         */
        async function fetchLocalitiesMap() {
            try {
                const response = await fetch(API_URL_LOCALITIES);
                if (!response.ok) return {};
                
                const json = await response.json();
                const localities = json.data; 
                
                const map = {};
                localities.forEach(item => {
                    map[item.globalIdLocal] = item.local;
                });
                return map;

            } catch (error) {
                console.error("Erro ao processar mapa de localidades:", error);
                return {};
            }
        }

        /**
         * 2. Função para agrupar os dados de previsão por Data.
         * @param {Array} data - Array de previsões do uv.json.
         * @returns {Object} Um objeto com as datas como chaves, e arrays de previsões como valores.
         */
        function groupForecastsByDate(data) {
            const grouped = {};
            data.forEach(item => {
                const date = item.data; // Usa o campo 'data' como chave
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(item);
            });
            return grouped;
        }
        
        /**
         * 3. Função principal para carregar o mapa de localizações e os dados UV.
         */
        async function carregarTabelaUV() {
            const corpoTabela = document.getElementById('tabela-corpo');
            corpoTabela.innerHTML = '<tr><td colspan="3" class="loading">A carregar mapa de localidades...</td></tr>';

            // Passo 1: Obter o mapa de localizações
            const localitiesMap = await fetchLocalitiesMap();
            const mapIsAvailable = Object.keys(localitiesMap).length > 0;
            
            if (!mapIsAvailable) {
                corpoTabela.innerHTML = '<tr><td colspan="3" class="error-message">Não foi possível carregar a lista de localidades para tradução.</td></tr>';
                return;
            }

            // Mudar o estado para carregamento dos dados UV
            corpoTabela.innerHTML = '<tr><td colspan="3" class="loading">A carregar dados de Índice UV...</td></tr>';
            
            try {
                // Passo 2: Obter os dados UV
                const respostaUV = await fetch(API_URL_UV);
                if (!respostaUV.ok) {
                    throw new Error(`Erro HTTP: ${respostaUV.status}. Não foi possível aceder à API UV.`);
                }
                
                const previsoes = await respostaUV.json(); 
                
                corpoTabela.innerHTML = ''; // Limpa o estado de carregamento

                if (!Array.isArray(previsoes) || previsoes.length === 0) {
                    corpoTabela.innerHTML = '<tr><td colspan="3" class="error-message">A API de UV não devolveu dados (Array vazio ou formato incorreto).</td></tr>';
                    return;
                }
                
                // Passo 3: Agrupar os dados
                const groupedData = groupForecastsByDate(previsoes);
                const sortedDates = Object.keys(groupedData).sort(); // Ordenar as datas

                let linhasAdicionadas = 0;

                // Passo 4: Construir a tabela, agrupando por data
                sortedDates.forEach(date => {
                    const forecastsForDay = groupedData[date];

                    // Formatar a data para ser mais legível (Ex: 2025-09-28)
                    const formattedDate = new Date(date).toLocaleDateString('pt-PT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                    // Adicionar cabeçalho do dia
                    const headerRow = corpoTabela.insertRow();
                    headerRow.classList.add('day-header');
                    const headerCell = headerRow.insertCell();
                    headerCell.colSpan = 3; 
                    headerCell.textContent = formattedDate.toUpperCase();
                    
                    // Preencher as linhas para cada previsão nesse dia
                    forecastsForDay.forEach(previsao => {
                        const idLocal = previsao.globalIdLocal;
                        const nomeLocal = localitiesMap[idLocal] || `ID: ${idLocal}`;
                        
                        // Campos de dados
                        const intervaloHora = previsao.intervaloHora || 'Dia Completo';
                        const iuv = previsao.iUv !== null && previsao.iUv !== undefined ? previsao.iUv : 'N/A';

                        const linha = corpoTabela.insertRow();
                        
                        // Primeira coluna: Intervalo de Hora
                        linha.insertCell().textContent = intervaloHora;
                        
                        // Segunda coluna: Localidade (Nome)
                        linha.insertCell().textContent = nomeLocal; 
                        
                        // Terceira coluna: Índice UV
                        linha.insertCell().textContent = iuv;
                        
                        linhasAdicionadas++;
                    });
                });

                if (linhasAdicionadas === 0) {
                     corpoTabela.innerHTML = '<tr><td colspan="3" class="error-message">A API devolveu dados, mas nenhum registo continha informações úteis.</td></tr>';
                }

            } catch (erro) {
                console.error('ERRO FATAL:', erro);
                corpoTabela.innerHTML = `<tr><td colspan="3" class="error-message">ERRO: Falha ao carregar ou processar dados UV. Detalhe: ${erro.message}</td></tr>`;
            }
        }

        document.addEventListener('DOMContentLoaded', carregarTabelaUV);
    </script>

</body>
</html>