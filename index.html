<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Índice UV - IPMA (Filtrado e Colorido)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        /* Estilo para a barra de filtros */
        .filters-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .filter-group select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1em;
        }
        table {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .day-header {
            background-color: #004a99;
            color: white;
            font-weight: bold;
            text-align: center !important;
            font-size: 1.1em;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: #007bff;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tr:nth-child(even):not(.day-header) {
            background-color: #f9f9f9;
        }
        tr:hover:not(.day-header) {
            background-color: #eef7ff;
        }
        .loading, .error-message {
            text-align: center;
            font-size: 1.1em;
            color: #666;
            padding: 20px;
        }
        .error-message {
            color: #d9534f;
            font-weight: bold;
        }
        
        /* === ESTILOS DE COR DE CÉLULA DO ÍNDICE UV === */
        .uv-extremo { background-color: #8c53ee; color: white; font-weight: bold; } /* Extremo: Roxo */
        .uv-muito-elevado { background-color: #dc3545; color: white; font-weight: bold; } /* Muito Elevado: Vermelho */
        .uv-elevado { background-color: #fd7e14; color: white; font-weight: bold; } /* Elevado: Laranja */
        .uv-moderado { background-color: #ffc107; color: #333; } /* Moderado: Amarelo */
        .uv-baixo { background-color: #28a745; color: white; } /* Baixo: Verde */
        .uv-indisponivel { background-color: #6c757d; color: white; } /* Indisponível: Cinzento */

        /* Estilo para a célula que contém o valor */
        .uv-cell {
            text-align: center;
            padding: 5px 10px; /* Reduz o padding para a célula do valor */
            line-height: 1.5;
        }
    </style>
</head>
<body>

    <h1>Previsão do Índice UV - IPMA</h1>

    <div class="filters-container">
        <div class="filter-group">
            <label for="filter-date">Filtrar por Data:</label>
            <select id="filter-date">
                <option value="all">Todas as Datas</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-locality">Filtrar por Localidade:</label>
            <select id="filter-locality">
                <option value="all">Todas as Localidades</option>
            </select>
        </div>
    </div>
    <table id="tabela-uv">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Localidade</th>
                <th>Índice UV Máximo (iUv)</th>
            </tr>
        </thead>
        <tbody id="tabela-corpo">
            <tr><td colspan="3" class="loading">A carregar dados...</td></tr>
        </tbody>
    </table>

    <script>
        const API_URL_UV = 'https://api.ipma.pt/open-data/forecast/meteorology/uv/uv.json';
        const API_URL_LOCALITIES = 'https://api.ipma.pt/open-data/distrits-islands.json';

        let fullData = [];
        let localitiesMap = {};

        // --- FUNÇÕES DE UTILIDADE ---

        function formatLocaleDate(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            try {
                return new Date(dateString).toLocaleDateString('pt-PT', options);
            } catch {
                return dateString;
            }
        }

        function groupForecastsByDate(data) {
            const grouped = {};
            data.forEach(item => {
                const date = item.data;
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(item);
            });
            return grouped;
        }

        /**
         * Retorna a classe CSS baseada no valor numérico do Índice UV.
         */
        function getUVClass(value) {
            const num = parseFloat(value);

            if (isNaN(num) || value === 'N/A' || num < 1) {
                return 'uv-indisponivel';
            }
            if (num >= 11) {
                return 'uv-extremo'; // 11+
            }
            if (num >= 8) {
                return 'uv-muito-elevado'; // 8, 9, 10
            }
            if (num >= 6) {
                return 'uv-elevado'; // 6, 7
            }
            if (num >= 3) {
                return 'uv-moderado'; // 3, 4, 5
            }
            if (num >= 1) {
                return 'uv-baixo'; // 1, 2
            }
            return 'uv-indisponivel'; // Fallback
        }
        
        // --- FUNÇÕES DE FETCH ---

        async function fetchLocalitiesMap() {
            try {
                const response = await fetch(API_URL_LOCALITIES);
                if (!response.ok) return {};
                const json = await response.json();
                
                const map = {};
                json.data.forEach(item => {
                    map[item.globalIdLocal] = item.local;
                });
                return map;

            } catch (error) {
                console.error("Erro ao processar mapa de localidades:", error);
                return {};
            }
        }

        // --- FUNÇÕES DE FILTRAGEM E RENDERIZAÇÃO ---

        function populateFilters(data, map) {
            const dateSelect = document.getElementById('filter-date');
            const localitySelect = document.getElementById('filter-locality');

            const uniqueDates = new Set();
            const uniqueLocalities = new Set();
            
            data.forEach(item => {
                if (item.data) uniqueDates.add(item.data);
                const localityName = map[item.globalIdLocal];
                if (localityName) uniqueLocalities.add(localityName);
            });

            dateSelect.innerHTML = '<option value="all">Todas as Datas</option>'; 
            Array.from(uniqueDates).sort().forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formatLocaleDate(date);
                dateSelect.appendChild(option);
            });

            localitySelect.innerHTML = '<option value="all">Todas as Localidades</option>';
            Array.from(uniqueLocalities).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                localitySelect.appendChild(option);
            });
        }
        
        function renderTable() {
            const selectedDate = document.getElementById('filter-date').value;
            const selectedLocality = document.getElementById('filter-locality').value;
            const corpoTabela = document.getElementById('tabela-corpo');
            
            // 1. Filtrar os dados
            let filteredData = fullData.filter(item => {
                const itemDate = item.data;
                const itemLocalityName = localitiesMap[item.globalIdLocal] || `ID: ${item.globalIdLocal}`;

                const dateMatch = selectedDate === 'all' || itemDate === selectedDate;
                const localityMatch = selectedLocality === 'all' || itemLocalityName === selectedLocality;

                return dateMatch && localityMatch;
            });

            corpoTabela.innerHTML = ''; // Limpa a tabela

            if (filteredData.length === 0) {
                corpoTabela.innerHTML = '<tr><td colspan="3" class="error-message">Não foram encontrados dados para os filtros selecionados.</td></tr>';
                return;
            }

            // 2. Agrupar os dados filtrados
            const groupedData = groupForecastsByDate(filteredData);
            const sortedDates = Object.keys(groupedData).sort(); 

            // 3. Renderizar o HTML da Tabela
            let linhasAdicionadas = 0;

            sortedDates.forEach(date => {
                const forecastsForDay = groupedData[date];

                // Adicionar cabeçalho do dia
                const headerRow = corpoTabela.insertRow();
                headerRow.classList.add('day-header');
                const headerCell = headerRow.insertCell();
                headerCell.colSpan = 3; 
                headerCell.textContent = formatLocaleDate(date).toUpperCase();
                
                // Preencher as linhas
                forecastsForDay.forEach(previsao => {
                    const idLocal = previsao.globalIdLocal;
                    const nomeLocal = localitiesMap[idLocal] || `ID: ${idLocal}`;
                    
                    const intervaloHora = previsao.intervaloHora || 'Dia Completo';
                    const iuv = previsao.iUv !== null && previsao.iUv !== undefined ? previsao.iUv : 'N/A';

                    if (nomeLocal === 'N/A' || iuv === 'N/A') return;

                    const linha = corpoTabela.insertRow();
                    
                    // Coluna Hora
                    linha.insertCell().textContent = intervaloHora;
                    
                    // Coluna Localidade
                    linha.insertCell().textContent = nomeLocal; 
                    
                    // Coluna Índice UV (Aplicação da cor)
                    const uvCell = linha.insertCell();
                    uvCell.textContent = iuv;
                    uvCell.classList.add('uv-cell');
                    uvCell.classList.add(getUVClass(iuv)); // AQUI A MÁGICA ACONTECE
                    
                    linhasAdicionadas++;
                });
            });

            if (linhasAdicionadas === 0) {
                 corpoTabela.innerHTML = '<tr><td colspan="3" class="error-message">Os dados filtrados estão incompletos. Tente filtros mais abrangentes.</td></tr>';
            }
        }

        // --- SETUP PRINCIPAL ---

        async function setupApp() {
            // Inicializa a tabela com a mensagem de carregamento
            document.getElementById('tabela-corpo').innerHTML = '<tr><td colspan="3" class="loading">A carregar mapa de localidades...</td></tr>';
            
            localitiesMap = await fetchLocalitiesMap();
            if (Object.keys(localitiesMap).length === 0) {
                document.getElementById('tabela-corpo').innerHTML = '<tr><td colspan="3" class="error-message">Erro ao carregar o mapa de localidades.</td></tr>';
                return;
            }

            try {
                document.getElementById('tabela-corpo').innerHTML = '<tr><td colspan="3" class="loading">A carregar dados de Índice UV...</td></tr>';

                const respostaUV = await fetch(API_URL_UV);
                if (!respostaUV.ok) throw new Error(`Erro HTTP: ${respostaUV.status}`);
                
                fullData = await respostaUV.json(); 

                if (!Array.isArray(fullData) || fullData.length === 0) {
                    document.getElementById('tabela-corpo').innerHTML = '<tr><td colspan="3" class="error-message">A API UV não devolveu dados válidos.</td></tr>';
                    return;
                }

                // Passo 3: Popular os filtros
                populateFilters(fullData, localitiesMap);

                // Passo 4: Adicionar event listeners aos filtros
                document.getElementById('filter-date').addEventListener('change', renderTable);
                document.getElementById('filter-locality').addEventListener('change', renderTable);
                
                // Passo 5: Renderizar a tabela pela primeira vez
                renderTable();

            } catch (erro) {
                console.error('ERRO FATAL NO SETUP:', erro);
                document.getElementById('tabela-corpo').innerHTML = `<tr><td colspan="3" class="error-message">Falha ao carregar os dados. Detalhe: ${erro.message}</td></tr>`;
            }
        }

        document.addEventListener('DOMContentLoaded', setupApp);
    </script>

</body>
</html>